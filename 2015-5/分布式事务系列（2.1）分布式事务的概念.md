#1 系列目录

-	[分布式事务系列（开篇）提出疑问和研究过程](http://my.oschina.net/pingpangkuangmo/blog/413518)
-	[分布式事务系列（1.1）Spring事务管理器PlatformTransactionManager源码分析](http://my.oschina.net/pingpangkuangmo/blog/415162)
-	[分布式事务系列（1.2）Spring事务体系]()
-	[分布式事务系列（2.1）分布式事务模型与接口定义]()


#2 X/Open DTP模型

之前我们接触的事务都是针对单个数据库的操作，如果涉及多个数据库的操作，还想保证原子性，这就需要使用分布式事务了。而X/Open DTP就是一种分布式事务处理模型。

##2.1 X/Open DTP模型

X/Open是一个组织，维基百科上这样说明：

> X/Open是1984年由多个公司联合创建的一个用于定义和推进信息技术领域开放标准的公司

上述组织就针对分布式事务提出了一个模型，即DTP模型(Distributed Transaction Process),该模型如下所示：

![DTP模型](https://static.oschina.net/uploads/img/201505/19061812_ny1A.png "DTP模型")

上面涉及了三个对象：

-	AP(Application Program)：应用程序
-	TM(Resource Manager)：事务管理器
	
	负责协调和管理事务，它和之前说的Spring的事务管理器PlatformTransactionManager可不一样。

-	RM(Transaction Manager)：资源管理器

	可以理解为数据库或者JMS。

他们三者的关系：

-	AP通过TM来操作多个RM，AP也可以通过RM的本地事务接口来操作单个RM
-	TM和RM可以互相通信，他们之前的通信协议就是XA协议，所以TM和RM就必须实现XA协议定义的接口

更多内容，可以参见[Distributed Transaction Processing:The XA Specification](http://pubs.opengroup.org/onlinepubs/009680699/toc.pdf)

##2.2 两阶段提交(The two-phase commit protocol,2PC)

当需要协调多个资源管理器进行分布式事务的时候，就需要使用到两阶段提交协议，如下图所示：

![两阶段提交协议](https://static.oschina.net/uploads/img/201505/19065944_pgTR.png "两阶段提交协议")

第一个阶段：事务管理器通过XA协议，向资源管理器发送prepare命令，询问他们预提交是否成功，每个资源管理器给出自己的响应，预提交成功或者失败

第二个阶段：根据第一个阶段的资源管理器的回复情况，如果全部表示预提交成功，则事务管理器向所有的资源管理器发送最终的提交命令。如果有一个资源管理器回复预提交失败，则事务管理器向所有的资源管理器发送回滚命令，全部进行回滚

通过这样的两阶段提交协议，即可完成了分布式事务的功能。这样的协议的正是基于了事务管理器和资源管理器的双向通信能力，而这在之前的本地事务中，如jdbc事务中，我们只能通过Connection向数据库传递命令，不能从数据库获取事务信息，这种情况是单向的。

然而还是存在一些问题的：

-	两阶段提交协议是阻塞式协议，所以事务管理器必须等待每一个资源管理器发送回复之后，才能进行下一步操作。一旦资源管理器挂掉，事务管理器则收不到响应，这就必须引入超时机制，一旦超过某个时间还没有回复，则认为失败，回滚所有操作，这些都是非常耗性能的。

-	一旦事务管理器挂掉，则资源管理器则一直等待事务管理器的命令。

更多资料与问题，见如下：

-	[InfoQ上的Java事务设计策略](http://www.infoq.com/cn/minibooks/JTDS)
-	[两阶段提交协议](http://book.51cto.com/art/201309/410608.htm)

##2.3 JTA接口定义

上述接口规范不是针对某种语言的，java是如何来落实上述规范的呢？这就是JTA的内容了。先来预览下JTA的包结构：

![JTA的包结构](https://static.oschina.net/uploads/img/201505/19084416_8mVV.png "JTA的包结构")

###2.3.1 AP、TM、RM三大对象

-	AP：我们的应用程序
-	TM：即javax.transaction.TransactionManager
-	RM：即javax.transaction.xa.XAResource

下面来详细说明：

TM：即javax.transaction.TransactionManager，总体接口定义如下：

![事务管理器接口定义](https://static.oschina.net/uploads/img/201505/19083037_jPoK.png "事务管理器接口定义")

-	begin():创建一个新的事务并关联到当前线程
-	Transaction getTransaction()：获取与当前线程关联的事务
-	commit():提交与当前线程关联的事务
-	rollback()：回滚与当前线程关联的事务
-	等等

定义了一些常用的事务操作，这里操作的事务的定义为javax.transaction.Transaction，接口如下所示：

![JTA事务的定义](https://static.oschina.net/uploads/img/201505/19083917_jQnY.png "JTA事务的定义")

-	commit()：提交事务
-	rollback()：回滚事务
-	enlistResource(XAResource xaRes)：把给定的XAResource（资源管理器的一个通信代表）加入当前事务中来，一个分布式事务会涉及多个资源管理器，该操作就是把某个资源管理器纳入当前事务中来
-	delistResource(XAResource xaRes, int flag)：把给定的XAResource（资源管理器的一个通信代表）从当前事务中去除，flag后面再详细说

RM:即javax.transaction.xa.XAResource，资源管理器的一个通信代表，我们通过XAResource与资源管理器器来通信。所以它的实现类实现了两阶段提交协议。






