#1 系列目录

-	[分布式事务系列（开篇）提出疑问和研究过程](http://my.oschina.net/pingpangkuangmo/blog/413518)
-	[分布式事务系列（1.1）Spring事务管理器PlatformTransactionManager源码分析](http://my.oschina.net/pingpangkuangmo/blog/415162)
-	[分布式事务系列（1.2）Spring事务体系](http://my.oschina.net/pingpangkuangmo/blog/416038)
-	[分布式事务系列（2.1）分布式事务模型与接口定义](http://my.oschina.net/pingpangkuangmo/blog/417479)

#2 了解xapool

我们在前一篇文章中了解到jotm配合xapool共同完成了分布式事务。jotm主要提供了事务管理器TransactionManager的功能。而xapool则通过使用非XA数据库驱动实现了XA数据库驱动的效果。深入了解xapool之前，我们需要认识下XA数据库驱动到底是什么

##2.1 XA数据库驱动

###2.1.1 DataSource和ConnectionPoolDataSource

先来看下javax.sql.DataSource接口内容：

	public interface DataSource  extends CommonDataSource,Wrapper {
	  Connection getConnection() throws SQLException;
	  Connection getConnection(String username, String password)
	    throws SQLException;
	}

DataSource就是提供Connection的。再来看下ConnectionPoolDataSource接口内容

	public interface ConnectionPoolDataSource  extends CommonDataSource {
	  PooledConnection getPooledConnection() throws SQLException;
	  PooledConnection getPooledConnection(String user, String password)
	    throws SQLException;
	 }

ConnectionPoolDataSource就是提供PooledConnection，它代表了一个与数据库的物理连接，接口如下：

	public interface PooledConnection {
 		Connection getConnection() throws SQLException;
		//略
	}

这个物理连接能够产生Connection。它作为PooledConnection的一个handle，即PooledConnection可以产生多个Connection来供使用。总结如下：

ConnectionPoolDataSource-》PooledConnection-》Connection

DataSource-》Connection

更多详细内容见[JDBC分布式事务浅析](http://developer.51cto.com/art/200906/130433.htm)

总之需要带着怀疑的眼光去看待问题，以上看法不一定对。如果想深入探究，就需要各位去仔细去斟酌。

###2.1.2 XADataSource

再来看下javax.sql.XADataSource的接口内容：

	public interface XADataSource extends CommonDataSource {
	  XAConnection getXAConnection() throws SQLException;
	  XAConnection getXAConnection(String user, String password)
	    throws SQLException;
	 }

XADataSource就是提供XAConnection的，什么是XAConnection呢？

	public interface XAConnection extends PooledConnection {
  		javax.transaction.xa.XAResource getXAResource() throws SQLException;
	}

可以看到XAConnection不仅能够获取Connection（PooledConnection的功能），还能获取与数据库通信的一个代表XAResource（上上一篇文章已说明，见[AP、TM、RM三大对象](http://my.oschina.net/pingpangkuangmo/blog/417479#OSC_h2_6)）

有了这个通信代表，我们就可以与数据库进行交互，实现两阶段提交协议。

###2.1.3 什么是XA数据库驱动

即实现了XADataSource接口的数据库驱动，它能够为我们创建XAConnection，有了XAConnection我们既能获取普通常见的Connection，又能获取XAResource，实现与数据库的交互，进而可以实现两阶段提交协议。

所以XA数据库驱动的最重要核心就是：有了XAResource的实现，能与数据库进行双向交互

目前大部分数据库都是支持XA驱动的，如

-	对mysql来说，我们所用的mysql-connector-java jar包，就是支持的，它所提供的XADataSource实现是： com.mysql.jdbc.jdbc2.optional.MysqlXADataSource
-	对oracle来说，它所提供的XADataSource实现是： oracle.jdbc.xa.client.OracleXADataSource

##2.2 xapool的内容

XA数据库驱动按道理上讲，应该是数据库来负责提供的。xapool就是在数据库驱动不是XA驱动的前提下，模拟了XA驱动。这种模拟情况下，与数据库的交互仍然是单向的。这也只是它的一个功能。

###2.2.1 xapool的整体功能

-	Generic Pool：一个pool的功能，用来存储Object
-	StandardDataSource和StandardXADataSource，分别用于产生Connection和XAConnection
-	StandardPoolDataSource和StandardXAPoolDataSource 对上述那一对dataSource加上了Generic Pool的功能，使用pool来维护和管理Connection（实际上是PooledConnection，后文会说到）和XAConnection

###2.2.2 认识GenericPool

它实现了一个pool的功能，和其他的pool的大体功能都差不多，它可以存储和管理任何对象。只要你实现了相应的接口，这里即PoolHelper接口，看下GenericPool的构造函数：

	public GenericPool(PoolHelper helper) {
		this(
			helper,
			DEFAULT_MINSIZE,
			DEFAULT_MAXSIZE,
			DEFAULT_EXPIRATION,
			DEFAULT_SLEEPTIME);
	}

它需要一个PoolHelper和一些参数设置（pool中object个数的最大值、最小值等）。来看下PoolHelper:

	public interface PoolHelper {
		public void expire(Object o); // object specific work to kill the object
		public boolean checkThisObject(Object o);
		// check if the object is still valid
		public boolean testThisObject(Object o); // check if the object is closed
		public GenerationObject create() throws SQLException;
		public GenerationObject create(String _user, String _password)
			throws SQLException;
		public String toString();
	}

可以看到GenericPool通过PoolHelper对外暴漏出一些方法，通过PoolHelper的create方法将创建的object存放至pool中，通过PoolHelper的expire方法将pool中的object真正意义上的删除掉（而不仅仅是从pool中移除）。

###2.2.3 StandardDataSource和StandardXADataSource

StandardDataSource需要实现DataSource的功能，即能够获取Connection。这个实现还是比较简单的，就是利用jdbc原始方式DriverManager来获取，如下：

	Connection conn=DriverManager.getConnection(url, prop)

StandardXADataSource需要实现XADataSource的功能，即能够获取XAConnection，同时通过XAConnection能获取XAResource。

这里的XAResource留到和jotm的事务管理器一起来说。

###2.2.4 StandardPoolDataSource和StandardXAPoolDataSource

StandardPoolDataSource:内部拥有一个GenericPool，它自己实现了PoolHelper，我们来看看它把什么对象交给pool来管理了，即看看它怎么实现PoolHelper的create方法的：

![StandardPoolDataSource向pool中存放的对象](https://static.oschina.net/uploads/img/201505/24110309_dkrr.png "StandardPoolDataSource向pool中存放的对象")

它内部拥有一个ConnectionPoolDataSource对象，即图片中cpds对象，它能够产生PooledConnection。

可以看到向pool中存放的对象，并不是Connection，而是PooledConnection，上文说过，它是与数据库的一个物理连接，它能够产生Connection。

总结一下就是：StandardPoolDataSource利用内部ConnectionPoolDataSource对象来创建PooledConnection，然后把创建的PooledConnection交给内部的GenericPool来维护和管理。


StandardXAPoolDataSource：内部拥有一个GenericPool，它自己实现了PoolHelper，我们来看看它把什么对象交给pool来管理了，即看看它怎么实现PoolHelper的create方法的：

![StandardXAPoolDataSource向pool中存放的对象](https://static.oschina.net/uploads/img/201505/24111621_A1AT.png "StandardXAPoolDataSource向pool中存放的对象")

它内部拥有一个XADataSource对象，即图片中的xads，它能够产生XAConnection。

可以看到向pool中存放的对象是XAConnection。

总结一下就是：StandardXAPoolDataSource利用内部的XADataSource对象来创建XAConnection，然后把创建的XAConnection交给内部的GenericPool来维护和管理。

#3 jotm的事务管理器


#4 jotm和xapool的交互

#5 结束语


















